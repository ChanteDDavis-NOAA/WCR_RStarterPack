---
title: "Untitled"
author: "Florian Priv√©"
date: "15 juin 2017"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## R Markdown

This is an R Markdown document. Markdown is a simple formatting syntax for authoring HTML, PDF, and MS Word documents. For more details on using R Markdown see <http://rmarkdown.rstudio.com>.

When you click the **Knit** button a document will be generated that includes both content as well as the output of any embedded R code chunks within the document. You can embed an R code chunk like this:

```{r cars}
library(dplyr)
library(leaflet)

members <- googlesheets::gs_read(
  googlesheets::gs_key(
    "1WyfmLfoAQUP2iRogqcOfYA9Hum7DT0BcVyTtei_6Xjw", 
    lookup = TRUE, visibility = "private"
  )
) %>% 
  tidyr::unite_(col = "Name", from = c("First name", "Last name"),
                sep = " ", remove = TRUE) %>%
  mutate(Name = if_else(is.na(Website), Name, 
                        paste0("<a href='", Website, "' target='_blank'>", Name, "</a>")))

members$Status[is.na(members$Status)] <- "member"
stopifnot(all(members$Status %in% c("member", "referent", "admin")))

members2 <- subset(members, select = -Website) %>% 
  mutate(
    infos = paste0(
      Name, "<br>",
      if_else(is.na(Institution), "", paste0("at ", Institution, "<br>")),
      if_else(is.na(Field), "", paste0("in ", Field, "<br>")),
      if_else(is.na(Keywords), "", paste0("knows ", Keywords))
    )
  )

members2 <- crosstalk::SharedData$new(members2)

suppressWarnings(
  leaflet(members2, width = "100%") %>% 
    setView(lng = 5.767249, lat = 45.190590, zoom = 12) %>% 
    addTiles(options = providerTileOptions(minZoom = 2, maxZoom = 20)) %>%
    addAwesomeMarkers(lng = 5.767249, lat = 45.190590, 
                      popup = "Meeting location",
                      label = "Meeting location",
                      icon = makeAwesomeIcon("android-locate", library = "ion", markerColor = "red")) %>%
    addAwesomeMarkers(                popup = ~infos,
                      label = ~lapply(infos, htmltools::HTML),
                      icon = makeAwesomeIcon("person", library = "ion", markerColor = ~if_else(Status == "member", "blue", "darkblue"))) %>%
    htmlwidgets::onRender('
      function(el, x) {
        var myMap = this;
        myMap.on("click", function(e) {
          alert("Latitude: " + e.latlng.lat + "\\nLongitude: " + e.latlng.lng)
        })
      }')
)

DT::datatable(data = members2,
              rownames = FALSE, escape = FALSE)


```
